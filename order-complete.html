{{#partial "page"}}
<main class="content">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PZSWV8M');</script>
<!-- End Google Tag Manager -->
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PZSWV8M"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<script>

var cartProducts = [];
var orderProducts = [];
var checkoutProducts = [];
var customerData = {};
var orderTotal = 0;

var isCart = '{{cart}}' ? true:false;
var isOrder = '{{order}}' ? true:false;
var isCustomer = '{{customer}}' ? true:false;
var isCheckout = window.location.pathname === '/checkout';
    
    function addDataToDataLayer(eventName) {
    window.dataLayer.push({
        'event': eventName,
        'cart_products': cartProducts,
        'order_products': orderProducts,
        'order_total': orderTotal,
        'checkout_products': checkoutProducts,
        'customer': customerData,
        'isCart': isCart,
        'isOrder': isOrder,
        'isCheckout': isCheckout,
        'isCustomer': isCustomer,
    });
}

function requestUserData(eventName) {
    if (document.querySelectorAll('.customerView > .customerView-body').length) {
        customerData.email = document.querySelectorAll('.customerView > .customerView-body')[0].textContent;
    }

    addDataToDataLayer(eventName);
}

if (isCheckout) {
    /* get the current cart contents */
    const Http = new XMLHttpRequest();
    const url = '/api/storefront/carts';
    Http.open("GET", url);
    Http.send();
    Http.onreadystatechange = (e) => {
        if (Http.readyState === 4) {
            var response = JSON.parse(Http.responseText);
            var cart = response[0].lineItems.physicalItems;
            for (var i = 0; i < cart.length; i++) {
                var product = cart[i];
                checkoutProducts.push({
                    'id': product.productId,
                    'name': product.name,
                    'sku': product.sku
                });
            }
            addDataToDataLayer('data_layer_ready');
            addDataToDataLayer('checkout');

        }
    }
    (e) => {
        console.log(Http.responseText);
    }

    window.addEventListener("click", function (event) {
        var id = event.target.id;
        if (id === 'checkout-customer-continue') {
            requestUserData('checkout_step_2')
        }
        if (id === 'checkout-shipping-continue') {
            requestUserData('checkout_step_3')
        }
        if (id === 'checkout-billing-continue') {
            requestUserData('checkout_step_4')
        }
        if (id === 'checkout-payment-continue') {
            requestUserData('checkout_step_5')
        }
    });
} else {
    {{#if cart}}
        {{#forEach cart.items}}
            cartProducts.push({
                'name': '{{name}}',
                'id': '{{id}}',
                'sku': '{{sku}}'
            });
        {{/forEach}}
    {{/if}}

    {{#if order}}
        {{#if order.total}}
            orderTotal = parseFloat('{{order.total.value}}');
        {{/if}}

        {{#forEach order.items}}
            orderProducts.push({
                'name': '{{name}}',
                'id': '{{order_product_id}}',
                'sku': '{{sku}}',
                'price':'{{price.value}}'
            });
        {{/forEach}}
    {{/if}}

    addDataToDataLayer('data_layer_ready');
}
</script>
	<div class="emthemesSarahmarket-box">
    <h1>Order Complete</h1>
    <p>Your order is complete. How awesome is that!</p>
    </div>
</main>
{{/partial}}
{{> layout/base}}
